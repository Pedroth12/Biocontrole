---
title: ""
---

# Ranking dos tratamentos

Nesta etapa, os dados foram organizados para calcular a AACPD (√°rea abaixo da curva de progresso da doen√ßa) por unidade experimental. Em seguida, ajustamos um modelo misto linear considerando o efeito fixo dos tratamentos e os efeitos aleat√≥rios associados √† estrutura hier√°rquica (planta, trif√≥lio, fol√≠olo e avaliador). Por fim, obtivemos as m√©dias ajustadas por tratamento e realizamos o teste de compara√ß√£o de m√©dias com ajuste de Tukey.

```{r}
# Pacotes necess√°rios
library(tidyverse)
library(pracma)
library(lme4)
library(lmerTest)
library(pbkrtest)
library(readxl)

# Importar os dados
dados <- read_excel("Trabalho final Emerson.xlsx", sheet = "Planilha1")
```

#### Calcular AACPD por unidade experimental

```{r}
aacpd_result <- dados %>%
  group_by(Tratamento, Planta, Trifolio, Foliolo, Avaliador) %>%
  summarise(
    AACPD = trapz(Dia, Severidade),
    .groups = "drop"
  )
```

#### Ajustar modelo misto com efeito fixo de Tratamento e estrutura hier√°rquica de efeitos aleat√≥rios

```{r}
modelo_completo <- lmer(
  AACPD ~ Tratamento + (1 | Planta/Trifolio/Foliolo/Avaliador),
  data = aacpd_result,
  REML = FALSE  # necess√°rio para compara√ß√£o de modelos
)

# 3. Ajustar modelo misto (se ainda n√£o tiver feito)
modelo_completo <- lmer(
  AACPD ~ Tratamento + (1 | Planta/Trifolio/Foliolo/Avaliador),
  data = aacpd_result,
  REML = TRUE  # pode voltar a usar REML aqui para melhores estimativas
)
```

Em seguida, usamos o pacote `emmeans` para extrair as m√©dias ajustadas por tratamento com base no modelo, e fizemos compara√ß√µes m√∫ltiplas com corre√ß√£o de Tukey. Tamb√©m ranqueamos os tratamentos com base nas diferen√ßas significativas entre eles.

```{r}
library(emmeans)
medias <- emmeans(modelo_completo, ~ Tratamento)
comparacoes <- pairs(medias, adjust = "tukey")
print(comparacoes)

# Letras para o ranking
ranking <- multcomp::cld(medias, Letters = letters)
print(ranking)

```

## Gr√°fico comparando os tratamentos

A seguir, geramos um gr√°fico de barras com as m√©dias ajustadas por tratamento, incluindo os intervalos de confian√ßa e as letras de signific√¢ncia estat√≠stica. Os nomes dos tratamentos foram padronizados e a ordem foi ajustada de acordo com a severidade m√©dia.

```{r}
library(emmeans)
library(multcomp)
library(ggplot2)
library(dplyr)
library(stringr)
# 1. Obter m√©dias ajustadas do modelo
medias <- emmeans(modelo_completo, ~ Tratamento)

# 2. Compara√ß√µes com Tukey + letras de signific√¢ncia
letras <- cld(medias, Letters = letters, adjust = "tukey")

# 3. Remover espa√ßos das letras
letras$.group <- gsub(" ", "", letras$.group)

# 4. Renomear tratamentos corretamente
letras$Tratamento <- letras$Tratamento %>%
  str_replace("(?i)isola[dt]o\\s*", "Iso. ") %>%
  str_replace("(?i)produto\\s*", "Prod. ") %>%
  str_replace("(?i)controle", "Cont.")
# 5. Ordenar por AACPD (emmean) e fixar ordem como fator
letras <- letras %>%
  arrange(emmean) %>%
  mutate(Tratamento = factor(Tratamento, levels = Tratamento))

# 6. Plot com nomes e ordem corrigidos
ggplot(letras, aes(x = Tratamento, y = emmean)) +
  geom_col(fill = "#4682B4", width = 0.7) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.2) +
  geom_text(aes(label = .group), vjust = -0.5, size = 5) +
  labs(
    title = "AACPD ajustado por tratamento",
    y = "AACPD (√°rea abaixo da curva)",
    x = "Tratamento"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

## Modelo Generalizado - TESTE DE AJUSTE VIA K-S

Nesta etapa, testamos a distribui√ß√£o dos valores de AACPD para avaliar a adequa√ß√£o de diferentes fam√≠lias de distribui√ß√µes (normal, gamma, log-normal e beta), usando o teste de Kolmogorov‚ÄìSmirnov (K-S). Isso nos ajuda a escolher a melhor fam√≠lia para ajuste de modelos generalizados.

```{r}
library(MASS)   # Para fitdistr
library(stats)

# Vetor de resposta
x <- aacpd_result$AACPD

# 1. Normal
ks.test(x, "pnorm", mean = mean(x), sd = sd(x))

# 2. Gamma
gamma_fit <- fitdistr(x, "gamma")
ks.test(x, "pgamma", shape = gamma_fit$estimate["shape"], rate = gamma_fit$estimate["rate"])

# 3. Log-Normal
ks.test(x, "plnorm", meanlog = mean(log(x)), sdlog = sd(log(x)))

# 4. Beta ‚Äî somente se seus dados estiverem entre 0 e 1
# Primeiro normaliza se necess√°rio
x_beta <- (x - min(x) + 0.001) / (max(x) - min(x) + 0.002)  # para garantir que caia entre (0,1)
beta_fit <- fitdistr(x_beta, dbeta, start = list(shape1 = 1, shape2 = 1))
ks.test(x_beta, "pbeta", shape1 = beta_fit$estimate["shape1"], shape2 = beta_fit$estimate["shape2"])

```

## Modelo Generalizado

Com base nos testes anteriores, ajustamos um modelo misto generalizado (GLMM) com distribui√ß√£o Gamma e link log, apropriado para vari√°veis cont√≠nuas, positivas e assim√©tricas como a AACPD. Realizamos diagn√≥stico dos res√≠duos e extra√≠mos as m√©dias ajustadas com as respectivas compara√ß√µes.

```{r}
# Pacotes
library(DHARMa)
library(readxl)
library(pracma)
library(emmeans)
library(multcompView)
library(multcomp)
library(stringr)

# 1. Carregar os dados
dados <- read_excel("Trabalho final Emerson.xlsx", sheet = "Planilha1")

# 2. Calcular AACPD por unidade experimental
aacpd_result <- dados %>%
  arrange(Planta, Trifolio, Foliolo, Avaliador, Tratamento, Dia) %>%
  group_by(Planta, Trifolio, Foliolo, Avaliador, Tratamento) %>%
  summarise(
    AACPD = trapz(Dia, Severidade),
    .groups = "drop"
  )

# 3. Ajustar valores zero (GLMM Gamma n√£o aceita zeros)
aacpd_result <- aacpd_result %>%
  mutate(AACPD_adj = AACPD + 0.01)

# 4. Modelo misto com distribui√ß√£o Gamma
modelo_glmm <- glmer(
  AACPD_adj ~ Tratamento + (1 | Planta/Trifolio/Foliolo/Avaliador),
  data = aacpd_result,
  family = Gamma(link = "log")
)

# 5. Diagn√≥stico
summary(modelo_glmm)
res_sim <- simulateResiduals(modelo_glmm)
plot(res_sim)

# 6. M√©dias ajustadas e letras
medias <- emmeans(modelo_glmm, ~ Tratamento, type = "response")
letras <- cld(medias, Letters = letters, adjust = "tukey")
letras$.group <- gsub(" ", "", letras$.group)

# 7. Renomear tratamentos
letras$Tratamento <- letras$Tratamento %>%
  str_replace("(?i)isola[dt]o\\s*", "Iso. ") %>%
  str_replace("(?i)produto\\s*", "Prod. ") %>%
  str_replace("(?i)controle", "Cont.")

# 8. Organizar para gr√°fico
letras_df <- letras[, c("Tratamento", "response", "SE", ".group")]

# Reordena com base nos valores m√©dios
ordem <- letras_df$Tratamento[order(letras_df$response)]
letras_df$Tratamento <- factor(letras_df$Tratamento, levels = ordem)

# 9. Gr√°fico
ggplot(letras_df, aes(x = Tratamento, y = response)) +
  geom_col(fill = "#66c2a5", width = 0.7) +
  geom_errorbar(aes(ymin = response - SE, ymax = response + SE), width = 0.2) +
  geom_text(aes(label = .group), vjust = -0.5, fontface = "bold", size = 5) +
  labs(
    title = "AACPD dos tratamentos",
    x = "Tratamentos",
    y = "AACPD"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

# AACPD em 28 dias

Para avaliar o desempenho dos tratamentos na fase inicial da epidemia, filtramos os dados at√© 28 dias ap√≥s a inocula√ß√£o. Repetimos a an√°lise com GLMM Gamma e geramos gr√°fico com m√©dias ajustadas e signific√¢ncia estat√≠stica.

```{r}
# -----------------------------
# üì¶ Pacotes
# -----------------------------
library(DHARMa)
library(readxl)
library(tidyverse)
library(pracma)
library(lme4)
library(emmeans)
library(multcompView)
library(multcomp)
library(stringr)

# -----------------------------
# üì• 1. Carregar os dados
# -----------------------------
dados <- read_excel("Trabalho final Emerson.xlsx", sheet = "Planilha1")

# -----------------------------
# üßπ 2. Filtrar at√© o dia 28
# -----------------------------
dados_filtrados_28 <- dados %>%
  filter(Dia <= 28)

# -----------------------------
# üìä 3. Calcular AACPD por unidade experimental
# -----------------------------
aacpd_result_28 <- dados_filtrados_28 %>%
  arrange(Planta, Trifolio, Foliolo, Avaliador, Tratamento, Dia) %>%
  group_by(Planta, Trifolio, Foliolo, Avaliador, Tratamento) %>%
  summarise(
    AACPD = trapz(Dia, Severidade),
    .groups = "drop"
  )

# -----------------------------
# ‚ö†Ô∏è 4. Ajustar valores zero (GLMM Gamma n√£o aceita zeros)
# -----------------------------
aacpd_result_28 <- aacpd_result_28 %>%
  mutate(AACPD_adj_28 = AACPD + 0.01)

# -----------------------------
# üèóÔ∏è 5. Modelo misto com distribui√ß√£o Gamma
# -----------------------------
modelo_glmm_28 <- glmer(
  AACPD_adj_28 ~ Tratamento + (1 | Planta/Trifolio/Foliolo/Avaliador),
  data = aacpd_result_28,
  family = Gamma(link = "log")
)

# -----------------------------
# üß™ 6. Diagn√≥stico de res√≠duos
# -----------------------------
summary(modelo_glmm_28)
res_sim_28 <- simulateResiduals(modelo_glmm_28)
plot(res_sim_28)

# -----------------------------
# üìä 7. M√©dias ajustadas e letras de signific√¢ncia
# -----------------------------
medias_28 <- emmeans(modelo_glmm_28, ~ Tratamento, type = "response")
letras_28 <- cld(medias_28, Letters = letters, adjust = "tukey")
letras_28$.group <- gsub(" ", "", letras_28$.group)

# Renomear tratamentos para gr√°fico
letras_28$Tratamento <- letras_28$Tratamento %>%
  str_replace("(?i)isola[dt]o\\s*", "Iso. ") %>%
  str_replace("(?i)produto\\s*", "Prod. ") %>%
  str_replace("(?i)controle", "Cont.")

# -----------------------------
# üì¶ 8. Organizar para gr√°fico
# -----------------------------
letras_df_28 <- letras_28[, c("Tratamento", "response", "SE", ".group")]

# Reordenar fatores para o gr√°fico
ordem_28 <- letras_df_28$Tratamento[order(letras_df_28$response)]
letras_df_28$Tratamento <- factor(letras_df_28$Tratamento, levels = ordem_28)

# -----------------------------
# üé® 9. Gr√°fico final
# -----------------------------
ggplot(letras_df_28, aes(x = Tratamento, y = response)) +
  geom_col(fill = "#CC5500", width = 0.7) +
  geom_errorbar(aes(ymin = response - SE, ymax = response + SE), width = 0.2) +
  geom_text(aes(label = .group), vjust = -0.5, fontface = "bold", size = 5) +
  labs(
    title = "AACPD dos tratamentos (at√© 28 dias)",
    x = "Tratamentos",
    y = "AACPD"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))



```

# AACPD 35 dias

Da mesma forma, realizamos uma an√°lise restrita aos primeiros 35 dias, refletindo a progress√£o intermedi√°ria da doen√ßa. As an√°lises seguem os mesmos procedimentos da etapa anterior.

```{r}
# -----------------------------
# üì¶ Pacotes
# -----------------------------
library(DHARMa)
library(readxl)
library(tidyverse)
library(pracma)
library(lme4)
library(emmeans)
library(multcompView)
library(multcomp)
library(stringr)

# -----------------------------
# üì• 1. Carregar os dados
# -----------------------------
dados <- read_excel("Trabalho final Emerson.xlsx", sheet = "Planilha1")

# -----------------------------
# üßπ 2. Filtrar at√© o dia 35
# -----------------------------
dados_filtrados_35 <- dados %>%
  filter(Dia <= 35)

# -----------------------------
# üìä 3. Calcular AACPD por unidade experimental
# -----------------------------
aacpd_result_35 <- dados_filtrados_35 %>%
  arrange(Planta, Trifolio, Foliolo, Avaliador, Tratamento, Dia) %>%
  group_by(Planta, Trifolio, Foliolo, Avaliador, Tratamento) %>%
  summarise(
    AACPD = trapz(Dia, Severidade),
    .groups = "drop"
  )

# -----------------------------
# ‚ö†Ô∏è 4. Ajustar valores zero (GLMM Gamma n√£o aceita zeros)
# -----------------------------
aacpd_result_35 <- aacpd_result_35 %>%
  mutate(AACPD_adj_35 = AACPD + 0.01)

# -----------------------------
# üèóÔ∏è 5. Modelo misto com distribui√ß√£o Gamma
# -----------------------------
modelo_glmm_35 <- glmer(
  AACPD_adj_35 ~ Tratamento + (1 | Planta/Trifolio/Foliolo/Avaliador),
  data = aacpd_result_35,
  family = Gamma(link = "log")
)

# -----------------------------
# üß™ 6. Diagn√≥stico de res√≠duos
# -----------------------------
summary(modelo_glmm_35)
res_sim_35 <- simulateResiduals(modelo_glmm_35)
plot(res_sim_35)

# -----------------------------
# üìä 7. M√©dias ajustadas e letras de signific√¢ncia
# -----------------------------
medias_35 <- emmeans(modelo_glmm_35, ~ Tratamento, type = "response")
letras_35 <- cld(medias_35, Letters = letters, adjust = "tukey")
letras_35$.group <- gsub(" ", "", letras_35$.group)

# Renomear tratamentos para gr√°fico
letras_35$Tratamento <- letras_35$Tratamento %>%
  str_replace("(?i)isola[dt]o\\s*", "Iso. ") %>%
  str_replace("(?i)produto\\s*", "Prod. ") %>%
  str_replace("(?i)controle", "Cont.")

# -----------------------------
# üì¶ 8. Organizar para gr√°fico
# -----------------------------
letras_df_35 <- letras_35[, c("Tratamento", "response", "SE", ".group")]

# Reordenar fatores para o gr√°fico
ordem_35 <- letras_df_35$Tratamento[order(letras_df_35$response)]
letras_df_35$Tratamento <- factor(letras_df_35$Tratamento, levels = ordem_35)

# -----------------------------
# üé® 9. Gr√°fico final
# -----------------------------
ggplot(letras_df_35, aes(x = Tratamento, y = response)) +
  geom_col(fill = "#BC8F8F", width = 0.7) +
  geom_errorbar(aes(ymin = response - SE, ymax = response + SE), width = 0.2) +
  geom_text(aes(label = .group), vjust = -0.5, fontface = "bold", size = 5) +
  labs(
    title = "AACPD dos tratamentos (at√© 35 dias)",
    x = "Tratamentos",
    y = "AACPD"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Com base nos resultados obtidos, foi poss√≠vel verificar que os diferentes tratamentos avaliados influenciaram significativamente a progress√£o da ferrugem asi√°tica da soja, conforme evidenciado pelas an√°lises de AACPD sob modelos mistos e modelos generalizados com distribui√ß√£o Gamma. O uso de modelos de efeitos mistos foi essencial para considerar a estrutura hier√°rquica dos dados e garantir estimativas robustas, controlando a varia√ß√£o associada √†s plantas, fol√≠olos e avaliadores. Os tratamentos foram comparados por meio de m√©dias ajustadas e agrupamentos estat√≠sticos, permitindo identificar quais estrat√©gias de manejo se destacaram no controle da doen√ßa ao longo do tempo.
